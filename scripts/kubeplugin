#!/bin/bash

# This script is a kubectl plugin that gets resource usage statistics for pods or nodes.
# It should be saved as 'kubectl-resource-stats' - preferred but not required naming convention and made executable.

# Usage: kubectl-resource-stats <pods|nodes> <namespace>

if [[ -z "$1" ]] || [[ -z "$2" ]]; then
  echo "Usage: kubectl-resource-stats <pods|nodes> <namespace>"
  exit 1
fi

RESOURCE_TYPE=$1
NAMESPACE=$2

kubectl top "$RESOURCE_TYPE" -n "$NAMESPACE" | tail -n +2 | while read -r line
do
  if [[ "$RESOURCE_TYPE" == "pods" ]]; then
    NAME=$(echo "$line" | awk '{print $1}')
    CPU=$(echo "$line" | awk '{print $2}')
    MEMORY=$(echo "$line" | awk '{print $3}')
  elif [[ "$RESOURCE_TYPE" == "nodes" ]]; then
    NAME=$(echo "$line" | awk '{print $1}')
    CPU=$(echo "$line" | awk '{print $2}')
    MEMORY=$(echo "$line" | awk '{print $4}')
  fi

  echo "$RESOURCE_TYPE, $NAMESPACE, $NAME, $CPU, $MEMORY"
done
